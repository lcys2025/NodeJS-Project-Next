<!DOCTYPE html>
<html lang="zh-HK">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - <%= company_name %>
  </title>
  <link rel="stylesheet" href="/index/style.css">
  <link rel="stylesheet" href="/dashboard/dashboard.css">
</head>

<body>
  <%- include('_partials/nav') %>
    <div class="dashboard-container">
      <h1>Welcome, <%= user.name %>!</h1>
      <p><strong>Plan:</strong> <%= user.plan.charAt(0).toUpperCase() + user.plan.slice(1) %> - $<%= data.paymentAmount %> (<%= data.paymentStatus || 'N/A' %>) <span style="float: right;"><strong>Remaining Trainer Days:</strong> <%= data.remainingTrainerDays %></span></p>
    </div>
    <div class="dashboard-actions">
    </div>

    <% if (locals.user && locals.user.role==='gymer' ) { %>
      <!-- Gymer Dashboard -->
      <div class="dashboard-section">
        <h2>Upcoming Sessions</h2>
        <% if (data.bookings && data.bookings.length> 0) { %>
          <div class="bookings-grid">
            <% data.bookings.forEach(booking=> { %>
              <div class="booking-card">
                <h3>
                  <%= booking.trainerId.name %>
                </h3>
                <p><strong>Date:</strong>
                  <%= booking.bookingDate.toDateString() %>
                </p>
                <p><strong>Type:</strong>
                  <%= booking.sessionType %>
                </p>
                <p><strong>Status:</strong> <span class="status-<%= booking.status %>">
                    <%= booking.status %>
                  </span></p>
              </div>
              <% }); %>
          </div>
          <% } else { %>
            <p>You have no upcoming sessions. Book one now!</p>
            <% } %>
      </div>

      <div class="dashboard-section">
        <h2>Quick Actions</h2>
        <div class="actions">
          <a href="/book" class="btn primary">Book New Session</a>
          <a href="/user/bookings" class="btn secondary">View All Bookings</a>
        </div>
      </div>

      <div class="dashboard-section">
        <h2>Available Trainers</h2>
        <% if (data.trainers && data.trainers.length> 0) { %>
          <div class="trainers-grid">
            <% data.trainers.forEach(trainer=> { %>
              <div class="trainer-card">
                <h3>
                  <%= trainer.name %>
                </h3>
                <a href="/book?trainer=<%= trainer._id %>&trainerName=<%= encodeURIComponent(trainer.name) %>" class="btn small">Book Now</a>
              </div>
              <% }); %>
          </div>
          <% } else { %>
            <p>No trainers available at this time.</p>
            <% } %>
      </div>

      <% } else if (user.role==='trainer' ) { %>
        <!-- Trainer Dashboard -->
        <div class="dashboard-section">
          <div class="calendar-navigation" style="margin-bottom: 1em; display: flex; align-items: center;">
            <form action="/dashboard" method="GET" style="display: inline;">
              <input type="hidden" name="month" value="<%= data.calendar.prevMonth %>">
              <input type="hidden" name="year" value="<%= data.calendar.prevYear %>">
              <button type="submit" class="btn small">Previous</button>
            </form>
            <span style="margin: 0 1em; flex: 1; text-align: center;">
              <strong>Your Schedule for <%= data.calendar.month %> <%= data.calendar.year %></strong>
            </span>
            <form action="/dashboard" method="GET" style="display: inline;">
              <input type="hidden" name="month" value="<%= data.calendar.nextMonth %>">
              <input type="hidden" name="year" value="<%= data.calendar.nextYear %>">
              <button type="submit" class="btn small">Next</button>
            </form>
          </div>
          <div class="calendar">
            <% data.calendar.days.forEach(day=> { %>
              <div class="calendar-day <%= day.booked ? 'booked' : 'available' %>">
                <div class="day-number">
                  <%= day.day %>
                </div>
                <% if (day.booked) { %>
                  <div class="booking-info">
                    <div>
                      <%= day.booking.userId.name %>
                    </div>
                    <div>
                      <%= day.booking.sessionType %>
                    </div>
                    <div class="status-<%= day.booking.status %>">
                      <%= day.booking.status %>
                    </div>
                    <form action="/dashboard/update-status" method="POST" class="status-form">
                      <input type="hidden" name="bookingId" value="<%= day.booking._id %>">
                      <select name="status" onchange="this.form.submit()">
                        <option value="pending" <%=day.booking.status==='pending' ? 'selected' : '' %>>Pending</option>
                        <option value="confirmed" <%=day.booking.status==='confirmed' ? 'selected' : '' %>>Confirmed</option>
                        <option value="completed" <%=day.booking.status==='completed' ? 'selected' : '' %>>Completed</option>
                        <option value="cancelled" <%=day.booking.status==='cancelled' ? 'selected' : '' %>>Cancelled</option>
                        <option value="no-show" <%=day.booking.status==='no-show' ? 'selected' : '' %>>No Show</option>
                      </select>
                    </form>
                  </div>
                <% } %>
              </div>
            <% }); %>
          </div>
        </div>

        <div class="dashboard-section">
          <h2>Upcoming Sessions</h2>
          <% if (data.bookings && data.bookings.length> 0) { %>
            <table class="bookings-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Member</th>
                  <th>Type</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% data.bookings.forEach(booking=> { %>
                  <tr>
                    <td>
                      <%= booking.bookingDate.toDateString() %>
                    </td>
                    <td>
                      <%= booking.userId.name %>
                    </td>
                    <td>
                      <%= booking.sessionType %>
                    </td>
                    <td class="status-<%= booking.status %>">
                      <%= booking.status %>
                    </td>
                    <td>
                      <form action="/dashboard/update-status" method="POST" class="status-form">
                        <input type="hidden" name="bookingId" value="<%= booking._id %>">
                        <select name="status" onchange="this.form.submit()">
                          <option value="pending" <%=booking.status==='pending' ? 'selected' : '' %>>Pending</option>
                          <option value="confirmed" <%=booking.status==='confirmed' ? 'selected' : '' %>>Confirmed
                          </option>
                          <option value="completed" <%=booking.status==='completed' ? 'selected' : '' %>>Completed
                          </option>
                          <option value="cancelled" <%=booking.status==='cancelled' ? 'selected' : '' %>>Cancelled
                          </option>
                          <option value="no-show" <%=booking.status==='no-show' ? 'selected' : '' %>>No Show</option>
                        </select>
                      </form>
                    </td>
                  </tr>
                  <% }); %>
              </tbody>
            </table>
            <% } else { %>
              <p>No upcoming sessions scheduled.</p>
              <% } %>
        </div>
        <% } %>
          <div class="dashboard-section">
            <h2>Remaining Trainer Days</h2>
            <p>You have <strong><%= data.remainingTrainerDays %></strong> trainer days left.</p>
          </div>
          </div>

          <script src="/dashboard/dashboard.js"></script>
</body>

</html>